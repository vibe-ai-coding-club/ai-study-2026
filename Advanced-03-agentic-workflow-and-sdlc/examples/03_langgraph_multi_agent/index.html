<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangGraph Multi-Agent Pipeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }
            70% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .stage-running {
            animation: pulse-ring 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="max-w-4xl mx-auto px-6 py-10">
        <!-- Header -->
        <h1 class="text-3xl font-bold text-white mb-2">LangGraph Multi-Agent Pipeline</h1>
        <p class="text-gray-400 mb-8">5개의 Agent가 협력하여 UI XML을 생성하는 파이프라인</p>

        <!-- Input Section -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <label for="prompt" class="block text-sm font-medium text-gray-300 mb-2">프롬프트</label>
            <textarea
                id="prompt"
                rows="3"
                class="w-full bg-gray-700 text-white rounded-lg p-3 border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none resize-none"
                placeholder="생성할 UI 화면을 설명하세요..."
            ></textarea>
            <div class="flex flex-wrap gap-2 mt-3">
                <button onclick="setPrompt('로그인 화면을 만들어주세요')" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded-md text-gray-300 transition">
                    로그인 화면
                </button>
                <button onclick="setPrompt('상품 목록 페이지를 설계해주세요')" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded-md text-gray-300 transition">
                    상품 목록
                </button>
                <button onclick="setPrompt('사용자 프로필 대시보드를 구성해주세요')" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded-md text-gray-300 transition">
                    대시보드
                </button>
            </div>
            <div class="mt-4 flex justify-end">
                <button
                    id="generateBtn"
                    onclick="startGeneration()"
                    class="bg-blue-600 hover:bg-blue-700 px-6 py-2.5 rounded-lg font-medium transition disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    &#9654; 생성 시작
                </button>
            </div>
        </div>

        <!-- Pipeline Timeline -->
        <div id="pipeline" class="hidden mb-8">
            <h2 class="text-lg font-semibold text-white mb-4">Pipeline Progress</h2>
            <div class="bg-gray-800 rounded-lg p-6">
                <div id="pipelineStages" class="flex items-center justify-between"></div>
            </div>
        </div>

        <!-- Retry Log -->
        <div id="retryLog" class="hidden mb-8">
            <h2 class="text-lg font-semibold text-yellow-400 mb-3">&#10227; Retry Log</h2>
            <div id="retryContent" class="bg-gray-800 rounded-lg p-4 border border-yellow-600/30 space-y-2"></div>
        </div>

        <!-- Result -->
        <div id="resultSection" class="hidden">
            <h2 class="text-lg font-semibold text-green-400 mb-3">&#10003; 생성 완료</h2>
            <pre id="resultXml" class="bg-gray-800 rounded-lg p-4 overflow-x-auto text-sm text-green-300 border border-green-600/30 whitespace-pre-wrap"></pre>
        </div>
    </div>

    <script>
    const STAGES = [
        { id: 'orchestrate', label: 'Orchestrator', desc: '작업 분해', step: 1 },
        { id: 'retrieve',    label: 'Retriever',    desc: '템플릿 검색', step: 2 },
        { id: 'analyze',     label: 'Analyzer',     desc: '패턴 분석', step: 3 },
        { id: 'generate',    label: 'Generator',    desc: 'XML 생성', step: 4 },
        { id: 'validate',    label: 'Validator',    desc: '검증',     step: 5 },
    ];

    function setPrompt(text) {
        document.getElementById('prompt').value = text;
    }

    function renderPipeline() {
        const container = document.getElementById('pipelineStages');
        container.innerHTML = '';

        STAGES.forEach((stage, i) => {
            const stageEl = document.createElement('div');
            stageEl.className = 'flex flex-col items-center min-w-0';
            stageEl.innerHTML = `
                <div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-600 text-gray-300 text-sm font-medium transition-all duration-300"
                     id="circle-${stage.id}">
                    ${stage.step}
                </div>
                <span class="text-xs mt-2 font-medium text-gray-400 transition-colors duration-300"
                      id="label-${stage.id}">${stage.label}</span>
                <span class="text-xs text-gray-500">${stage.desc}</span>
            `;
            container.appendChild(stageEl);

            if (i < STAGES.length - 1) {
                const line = document.createElement('div');
                line.className = 'flex-1 h-0.5 bg-gray-600 mx-2 mt-[-20px] transition-colors duration-300';
                line.id = `line-${i}`;
                container.appendChild(line);
            }
        });
    }

    function updateStage(agentId, status) {
        const circle = document.getElementById(`circle-${agentId}`);
        const label = document.getElementById(`label-${agentId}`);
        if (!circle) return;

        const stageIdx = STAGES.findIndex(s => s.id === agentId);

        if (status === 'running') {
            circle.className = 'w-10 h-10 rounded-full flex items-center justify-center bg-blue-500 text-white text-sm font-medium transition-all duration-300 stage-running';
            label.className = 'text-xs mt-2 font-medium text-blue-400 transition-colors duration-300';
        } else if (status === 'done') {
            circle.className = 'w-10 h-10 rounded-full flex items-center justify-center bg-green-500 text-white text-sm font-medium transition-all duration-300';
            circle.innerHTML = '&#10003;';
            label.className = 'text-xs mt-2 font-medium text-green-400 transition-colors duration-300';
            // 이전 연결선 녹색으로 변경
            if (stageIdx > 0) {
                const line = document.getElementById(`line-${stageIdx - 1}`);
                if (line) line.className = 'flex-1 h-0.5 bg-green-500 mx-2 mt-[-20px] transition-colors duration-300';
            }
        } else if (status === 'pending') {
            const step = STAGES[stageIdx]?.step || '';
            circle.className = 'w-10 h-10 rounded-full flex items-center justify-center bg-gray-600 text-gray-300 text-sm font-medium transition-all duration-300';
            circle.innerHTML = step;
            label.className = 'text-xs mt-2 font-medium text-gray-400 transition-colors duration-300';
        }
    }

    async function startGeneration() {
        const prompt = document.getElementById('prompt').value.trim();
        if (!prompt) return;

        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.textContent = '⏳ 생성 중...';

        // UI 초기화
        document.getElementById('pipeline').classList.remove('hidden');
        document.getElementById('retryLog').classList.add('hidden');
        document.getElementById('resultSection').classList.add('hidden');
        document.getElementById('retryContent').innerHTML = '';

        renderPipeline();

        try {
            const response = await fetch('/api/generate/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt }),
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const parts = buffer.split('\n\n');
                buffer = parts.pop();

                for (const part of parts) {
                    const line = part.trim();
                    if (!line.startsWith('data: ')) continue;

                    try {
                        const data = JSON.parse(line.slice(6));
                        handleEvent(data);
                    } catch (e) {
                        console.warn('SSE parse error:', e);
                    }
                }
            }
        } catch (error) {
            console.error('Stream error:', error);
        }

        btn.disabled = false;
        btn.innerHTML = '&#9654; 생성 시작';
    }

    function handleEvent(event) {
        switch (event.type) {
            case 'agent_start':
                updateStage(event.agent, 'running');
                break;

            case 'agent_complete':
                updateStage(event.agent, 'done');
                break;

            case 'retry':
                document.getElementById('retryLog').classList.remove('hidden');
                const retryEl = document.createElement('div');
                retryEl.className = 'text-sm';
                retryEl.innerHTML = `
                    <span class="text-yellow-400 font-medium">재시도 #${event.retry_count}</span>
                    <span class="text-gray-400 ml-2">${event.feedback}</span>
                `;
                document.getElementById('retryContent').appendChild(retryEl);
                // Generator, Validator를 pending으로 리셋
                updateStage('generate', 'pending');
                updateStage('validate', 'pending');
                break;

            case 'result':
                document.getElementById('resultSection').classList.remove('hidden');
                document.getElementById('resultXml').textContent = event.xml;
                break;
        }
    }
    </script>
</body>
</html>
